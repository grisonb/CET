<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Calcul CET</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 16px;
      line-height: 1.4;
    }

    h1 {
      font-size: 2rem;
      text-align: center;
      margin-bottom: 10px;
    }

    .bloc {
      border: 1px solid #e0e0e0;
      padding: 12px 18px;
      margin-bottom: 15px;
      border-radius: 8px;
      background: #fafafa;
    }

    .bloc-agent {
      border: 1px solid #c5d8f5;
      background: #e8f3ff;
    }

    .row {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .row .bloc {
      flex: 1 1 0;
    }

    @media (max-width: 900px) {
      .row {
        flex-direction: column;
      }
    }

    label {
      display: block;
      font-weight: 600;
      margin-top: 14px;
    }

    input[type="number"] {
      display: block;
      width: 110px;
      padding: 6px;
      margin-top: 6px;
      font-size: 1rem;
      letter-spacing: 1px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    select {
      margin-left: 8px;
      padding: 4px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .resultat input {
      background: #eee;
      font-weight: bold;
      width: 130px;
    }

    button {
      margin-top: 18px;
      padding: 10px 14px;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .btn-primary {
      background: #1976d2;
      color: #fff;
      border-color: #1565c0;
    }
    .btn-primary:hover {
      background: #1565c0;
    }

    .btn-danger {
      background: #e53935;
      color: #fff;
      border-color: #c62828;
    }
    .btn-danger:hover {
      background: #c62828;
    }

    .graph1607-container {
      margin-top: 14px;
    }

    .graph1607-label-row {
      position: relative;
      margin-bottom: 4px;
      height: 18px;
    }

    .graph1607-label-main {
      position: absolute;
      left: 0;
      right: 0;
      text-align: center;
      font-weight: 600;
    }

    .graph1607-label-sup {
      position: absolute;
      right: 0;
      font-weight: 600;
    }

    .graph1607-bar-bg {
      position: relative;
      width: 100%;
      max-width: 500px;
      height: 20px;
      background: #ddd;
      border-radius: 10px;
      overflow: hidden;
      margin: 0 auto;
      display: flex;
    }

    .graph1607-bar-fill {
      height: 100%;
      background: #4caf50;
      width: 0%;
    }

    .graph1607-bar-sup {
      height: 100%;
      background: #f44336;
      width: 0%;
    }

    #resume {
      margin-top: 14px;
      font-size: 0.9rem;
      border-top: 1px solid #ddd;
      padding-top: 8px;
      line-height: 1.6;
    }

    #quickSummary {
      margin: 10px 0;
      padding: 8px 12px;
      border-radius: 6px;
      background: #e8f3ff;
      border: 1px solid #c5d8f5;
      font-weight: 600;
      font-size: 1.45rem;
    }

    .epargne-ok {
      background: #d8f5dd !important;
      border-color: #8bc68f !important;
    }

    .epargne-nok {
      background: #fbd5d5 !important;
      border-color: #e59a9a !important;
    }

    #modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #modalBox {
      background: #ffffff;
      padding: 18px 22px;
      border-radius: 12px;
      max-width: 520px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      font-size: 0.95rem;
    }

    #modalTitle {
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    #modalText {
      margin-bottom: 16px;
      line-height: 1.5;
    }

    #modalCloseBtn {
      display: inline-block;
      padding: 7px 16px;
      border-radius: 20px;
      border: none;
      background: #4caf50;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      float: right;
    }

    #modalCloseBtn:hover {
      background: #43a047;
    }

    /* ----- Optimisation smartphone ----- */
    @media (max-width: 600px) {
      body {
        margin: 10px auto;
        padding: 0 8px;
        font-size: 0.95rem;
      }

      h1 {
        font-size: 1.4rem;
      }

      /* On ne force PAS la largeur des inputs à 100% sur mobile */
      button {
        width: 100%;
      }

      #quickSummary {
        font-size: 1.1rem;
      }

      .graph1607-bar-bg {
        max-width: 100%;
      }
    }
  </style>
</head>

<body>
  <h1>Gestion des jours épargnables (épargne temps / €€€)</h1>

  <div id="quickSummary">Synthèse jours épargnables : en attente de calcul.</div>

  <!-- LIGNE 1 -->
  <div class="row">

    <!-- Données -->
    <div class="bloc bloc-agent">
      <h2>Données de l'agent</h2>

      <label>
        Heures effectuées dans l'année :
        <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
          <input type="number" id="heures" step="0.1" min="0">
          <select id="annee" onchange="majLibelleCR()"></select>
        </div>
      </label>

      <label>
        Nombre de CA restant (jours) :
        <input type="number" id="caRestant" step="1" min="0">
      </label>

      <label>
        Nombre de RTT restant (jours) :
        <input type="number" id="rttRestant" step="1" min="0">
      </label>

      <label>
        CRN-1 (jours) :
        <input type="number" id="crn1" step="0.01" min="0">
      </label>

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button type="button" class="btn-primary" onclick="calculCET()">Calculer</button>
        <button type="button" class="btn-danger" onclick="resetAll()">Remise à 0</button>
      </div>
    </div>

    <!-- Résultats principaux -->
    <div class="bloc resultat">
      <h2>Résultats</h2>

      <div class="graph1607-container">
        <div class="graph1607-label-row">
          <div class="graph1607-label-main" id="labelMain">
            0 / 1607 h
          </div>
          <div class="graph1607-label-sup" id="labelSup"></div>
        </div>

        <div class="graph1607-bar-bg" id="bg1607">
          <div class="graph1607-bar-fill" id="bar1607"></div>
          <div class="graph1607-bar-sup" id="barSup"></div>
        </div>
      </div>

      <label>
        Heures restantes pour atteindre 1607h :
        <input type="number" id="heuresRestantes" readonly>
      </label>

      <label>
        CRN-1 utilisés pour atteindre 1607h (jours) :
        <input type="number" id="crn1Utilises" readonly>
      </label>

      <label>
        Heures supplémentaires :
        <input type="number" id="heuresSupp" readonly>
      </label>

      <label>
        Jours théoriques issus des heures supp (heures supp / 7,8) :
        <input type="number" id="joursTheoriques" readonly>
      </label>

      <label>
        Épargne totale possible (jours) :
        <input type="number" id="epargnePossible" readonly>
      </label>
    </div>
  </div>

  <!-- LIGNE 2 -->
  <div class="row">
    <div class="bloc resultat">
      <h3>Épargne CA / RTT / CR</h3>

      <label>
        CA épargnables (9 jours maxi) :
        <input type="number" id="caEpargnables" readonly>
      </label>

      <label>
        RTT épargnables (21 jours maxi - 1 jour solidarité) :
        <input type="number" id="rttEpargnables" readonly>
      </label>

      <label id="crLabel">
        CR utilisable en <span id="crAnnee"></span> :
        <input type="number" id="crJours" readonly>
      </label>

      <label>
        CRN-1 épargnables (15 jours maxi) :
        <input type="number" id="crn1Epargnables" readonly>
      </label>

      <label>
        CRN-2 compteur exceptionnel :
        <input type="number" id="crn2" readonly>
      </label>

      <div id="resume"></div>
    </div>
  </div>

  <!-- MODALE -->
  <div id="modalOverlay">
    <div id="modalBox">
      <div id="modalTitle">Résumé de votre situation CET</div>
      <div id="modalText"></div>
      <button id="modalCloseBtn" onclick="hideModal()">Fermer</button>
      <div style="clear:both;"></div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    function formatNum(n) {
      return Number.isInteger(n) ? n.toString() : n.toFixed(2);
    }

    // Arrondi "jours" vers le bas, sans décimal
    function floorDay(n) {
      return Math.floor((n || 0) + 1e-9);
    }

    function initAnnee() {
      const select = document.getElementById("annee");
      const current = new Date().getFullYear();

      for (let a = 2023; a <= 2032; a++) {
        const opt = document.createElement("option");
        opt.value = a;
        opt.textContent = a;
        if (a === current) opt.selected = true;
        select.appendChild(opt);
      }

      majLibelleCR();
    }

    function majLibelleCR() {
      const annee = parseInt(document.getElementById('annee').value, 10);
      document.getElementById('crAnnee').textContent = annee + 1;
    }

    function showModal(htmlContent) {
      document.getElementById('modalText').innerHTML = htmlContent;
      document.getElementById('modalOverlay').style.display = 'flex';
    }

    function hideModal() {
      document.getElementById('modalOverlay').style.display = 'none';
    }

    function resetEpargneColors() {
      ['caEpargnables', 'rttEpargnables', 'crn1Epargnables', 'crJours', 'crn2'].forEach(id => {
        document.getElementById(id).classList.remove('epargne-ok', 'epargne-nok');
      });
    }

    function resetAll() {
      document.getElementById('heures').value = '';
      document.getElementById('caRestant').value = '';
      document.getElementById('rttRestant').value = '';
      document.getElementById('crn1').value = '';

      const ids = [
        'heuresRestantes','heuresSupp','joursTheoriques','epargnePossible',
        'caEpargnables','rttEpargnables','crn1Epargnables','crJours',
        'crn1Utilises','crn2'
      ];
      ids.forEach(id => document.getElementById(id).value = 0);

      document.getElementById('bar1607').style.width = '0%';
      document.getElementById('barSup').style.width = '0%';
      document.getElementById('labelMain').textContent = '0 / 1607 h';
      document.getElementById('labelSup').textContent = '';

      document.getElementById('resume').innerHTML = '';
      document.getElementById('quickSummary').textContent = 'Synthèse jours épargnables : en attente de calcul.';
      resetEpargneColors();
      hideModal();
    }

    function calculCET() {
      const heures = parseFloat(document.getElementById('heures').value) || 0;
      const caRestant = parseFloat(document.getElementById('caRestant').value) || 0;
      const rttRestant = parseFloat(document.getElementById('rttRestant').value) || 0;
      const crn1Input = parseFloat(document.getElementById('crn1').value) || 0;

      const HEURES_ANNUELLES = 1607;
      const HEURES_PAR_JOUR = 7.8;

      let caEpargnables = 0;
      let rttEpargnables = 0;
      let crJours = 0;
      let heuresSupp = 0;
      let joursTheoriques = 0;
      let heuresRestantes = 0;

      let crn1Utilises = 0;
      let crn1Epargnables = 0;
      let crn2 = 0;
      let crn1RestantsLogiques = 0;

      let seuil1607Atteint = false;
      let eligibleEpargneCA = false;
      let explicationCA = "";

      // Pour l'explication RTT générés - 1 solidarité
      let baseRTTEligibles = 0;

      if (heures >= HEURES_ANNUELLES) {
        seuil1607Atteint = true;
        eligibleEpargneCA = true;
        heuresRestantes = 0;
        heuresSupp = heures - HEURES_ANNUELLES;
      } else {
        heuresRestantes = HEURES_ANNUELLES - heures;
      }

      if (!seuil1607Atteint && crn1Input > 0) {
        const heuresManquantes = HEURES_ANNUELLES - heures;
        const joursManquants = heuresManquantes / HEURES_PAR_JOUR;

        if (crn1Input >= joursManquants) {
          crn1Utilises = joursManquants;
          seuil1607Atteint = true;
          eligibleEpargneCA = true;
          heuresRestantes = 0;
        }
      }

      if (eligibleEpargneCA) {
        if (caRestant <= 9) {
          caEpargnables = caRestant;
        } else {
          caEpargnables = 0;
          explicationCA =
            "Vous avez bien atteint les 1607 h, mais vous ne pouvez pas épargner de CA car il vous reste plus de 9 jours, ce qui signifie que vous n’avez pas posé les 20 jours minimum de CA requis.";
        }
      }

      if (heuresSupp > 0) {
        joursTheoriques = heuresSupp / HEURES_PAR_JOUR;

        const joursPleins = Math.floor(joursTheoriques + 1e-9);

        if (joursPleins > 0) {
          const PLAFOND_RTT_THEORIQUE = 21;
          baseRTTEligibles = Math.min(rttRestant, joursPleins, PLAFOND_RTT_THEORIQUE);

          const rttApresSolidarite = Math.max(0, baseRTTEligibles - 1);

          const PLAFOND_RTT_CET = 20;
          rttEpargnables = Math.min(PLAFOND_RTT_CET, rttApresSolidarite);

          crJours = Math.floor((joursTheoriques - baseRTTEligibles) + 1e-9);
        } else {
          rttEpargnables = 0;
          crJours = 0;
        }
      }

      if (seuil1607Atteint) {
        crn1RestantsLogiques = Math.max(0, crn1Input - crn1Utilises);
        crn1Epargnables = Math.min(crn1RestantsLogiques, 15);
        crn2 = Math.max(0, crn1RestantsLogiques - crn1Epargnables);
      }

      const epargnePossible = caEpargnables + rttEpargnables + crn1Epargnables;

      // ----- Arrondis pour l'AFFICHAGE des jours -----
      const caEpargnablesInt         = floorDay(caEpargnables);
      const rttEpargnablesInt        = floorDay(rttEpargnables);
      const crn1EpargnablesInt       = floorDay(crn1Epargnables);
      const crJoursInt               = floorDay(crJours);
      const crn1UtilisesInt          = floorDay(crn1Utilises);
      const crn2Int                  = floorDay(crn2);
      const epargnePossibleInt       = floorDay(epargnePossible);
      const joursTheoriquesInt       = floorDay(joursTheoriques);
      const crn1RestantsLogiquesInt  = floorDay(crn1RestantsLogiques);
      const baseRTTEligiblesInt      = floorDay(baseRTTEligibles);

      // ----- Mise à jour des champs -----
      document.getElementById("epargnePossible").value = epargnePossibleInt;
      document.getElementById("caEpargnables").value = caEpargnablesInt;
      document.getElementById("rttEpargnables").value = rttEpargnablesInt;
      document.getElementById("crn1Epargnables").value = crn1EpargnablesInt;
      document.getElementById("crJours").value = crJoursInt;
      document.getElementById("heuresSupp").value = formatNum(heuresSupp);       // heures → décimal ok
      document.getElementById("joursTheoriques").value = joursTheoriquesInt;     // jours → entier
      document.getElementById("heuresRestantes").value = formatNum(heuresRestantes);
      document.getElementById("crn1Utilises").value = crn1UtilisesInt;
      document.getElementById("crn2").value = crn2Int;

      const bar = document.getElementById("bar1607");
      const barSup = document.getElementById("barSup");
      const labMain = document.getElementById("labelMain");
      const labSup = document.getElementById("labelSup");

      let heuresEquivalentes =
        seuil1607Atteint ? HEURES_ANNUELLES : Math.min(heures, HEURES_ANNUELLES);

      labMain.textContent = `${formatNum(heuresEquivalentes)} / 1607 h`;

      if (heuresSupp > 0) {
        const total = HEURES_ANNUELLES + heuresSupp;
        const greenPct = (HEURES_ANNUELLES / total) * 100;
        const redPct = (heuresSupp / total) * 100;

        bar.style.width = greenPct + "%";
        barSup.style.width = redPct + "%";

        bar.style.borderRadius = "10px 0 0 10px";
        barSup.style.borderRadius = "0 10px 10px 0";

        labSup.textContent = `+${formatNum(heuresSupp)} h sup`;
      } else {
        labSup.textContent = "";
        if (seuil1607Atteint) {
          bar.style.width = "100%";
        } else {
          bar.style.width = (heures / HEURES_ANNUELLES) * 100 + "%";
        }
        barSup.style.width = "0%";
      }

      let resume = "";

      if (seuil1607Atteint) {
        if (heures >= 1607) {
          const supp = heures - 1607;
          resume += `Vous atteignez le seuil de 1607 h uniquement avec vos heures effectuées.<br><br>`;
          resume += `Vous avez effectué ${formatNum(heures)}h, soit ${formatNum(supp)}h supplémentaires.<br><br>`;
        } else {
          resume += `Vous atteignez le seuil de 1607 h grâce à ${crn1UtilisesInt} jour(s) de CRN-1 utilisés.<br><br>`;
        }

        if (rttEpargnablesInt > 0 && baseRTTEligiblesInt > 0) {
          resume += `Vous pouvez épargner ${caEpargnablesInt} jour(s) de CA et ${rttEpargnablesInt} jour(s) de RTT (${baseRTTEligiblesInt} jours de RTT épargnables générés moins 1 jour de solidarité).<br>`;
        } else {
          resume += `Vous pouvez épargner ${caEpargnablesInt} jour(s) de CA et ${rttEpargnablesInt} jour(s) de RTT.<br>`;
        }

        if (explicationCA !== "") {
          resume += `<br><span style="color:#c62828;">${explicationCA}</span><br>`;
        }

        resume += `<br>Il vous reste ${crn1RestantsLogiquesInt} jour(s) de CRN-1 après utilisation, dont ${crn1EpargnablesInt} jour(s) épargnable(s).<br><br>`;
        resume += `Le surplus éventuel de CRN-1 alimente ${crn2Int} jour(s) de CRN-2.`;
      } else {
        resume += `Vous n'atteignez pas le seuil de 1607 h : il manque encore ${formatNum(heuresRestantes)} heure(s).<br><br>`;
        if (crn1Input > 0) {
          resume += `Vos ${formatNum(crn1Input)} CRN-1 ne suffisent pas à atteindre 1607 h et ne sont donc pas épargnables cette année.`;
        } else {
          resume += `Vous ne disposez d'aucun CRN-1 pour combler ce manque.`;
        }
      }

      document.getElementById('resume').innerHTML = resume;

      document.getElementById('quickSummary').textContent =
        `Synthèse jours épargnables : ${caEpargnablesInt} CA / ${rttEpargnablesInt} RTT / ${crn1EpargnablesInt} CRN-1 / ${crJoursInt} CR / ${crn2Int} CRN-2`;

      resetEpargneColors();

      const caField   = document.getElementById('caEpargnables');
      const rttField  = document.getElementById('rttEpargnables');
      const crn1Field = document.getElementById('crn1Epargnables');
      const crField   = document.getElementById('crJours');
      const crn2Field = document.getElementById('crn2');

      (caEpargnablesInt > 0 ? caField.classList.add('epargne-ok') : caField.classList.add('epargne-nok'));
      (rttEpargnablesInt > 0 ? rttField.classList.add('epargne-ok') : rttField.classList.add('epargne-nok'));
      (crn1EpargnablesInt > 0 ? crn1Field.classList.add('epargne-ok') : crn1Field.classList.add('epargne-nok'));
      (crJoursInt > 0 ? crField.classList.add('epargne-ok') : crField.classList.add('epargne-nok'));

      if (crn2Int > 0) crn2Field.classList.add('epargne-ok');

      showModal(resume);
    }

    function initInputs() {
      const editableNumberInputs = document.querySelectorAll('input[type="number"]:not([readonly])');
      editableNumberInputs.forEach(input => {
        input.addEventListener('focus', function () {
          setTimeout(() => {
            input.select();
          }, 0);
        });
      });
    }

    initAnnee();
    initInputs();
  </script>

</body>
</html>
