<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Calcul CET</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1100px;
      margin: 20px auto;
      line-height: 1.4;
    }

    h1 {
      font-size: 2rem;  /* ‚Üê taille augment√©e */
      text-align: center;
      margin-bottom: 10px;
    }

    /* Blocs neutres par d√©faut */
    .bloc {
      border: 1px solid #e0e0e0;
      padding: 12px 18px;
      margin-bottom: 15px;
      border-radius: 8px;
      background: #fafafa;
    }

    /* Bloc Donn√©es de l‚Äôagent en bleu */
    .bloc-agent {
      border: 1px solid #c5d8f5;
      background: #e8f3ff;
    }

    .row {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .row .bloc {
      flex: 1 1 0;
    }

    @media (max-width: 900px) {
      .row {
        flex-direction: column;
      }
    }

    label {
      display: block;
      font-weight: 600;
      margin-top: 14px;
    }

    input[type="number"] {
      display: block;
      width: 100px;
      padding: 6px;
      margin-top: 6px;
      font-size: 1rem;
      letter-spacing: 1px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    select {
      margin-left: 8px;
      padding: 4px;
      font-size: 0.9rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .resultat input {
      background: #eee;
      font-weight: bold;
      width: 120px;
    }

    button {
      margin-top: 18px;
      padding: 10px 14px;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .btn-primary {
      background: #1976d2;
      color: #fff;
      border-color: #1565c0;
    }
    .btn-primary:hover {
      background: #1565c0;
    }

    .btn-danger {
      background: #e53935;
      color: #fff;
      border-color: #c62828;
    }
    .btn-danger:hover {
      background: #c62828;
    }

    /* Barre graphique */
    .graph1607-container {
      margin-top: 14px;
    }

    .graph1607-label-row {
      position: relative;
      margin-bottom: 4px;
      height: 18px;
    }

    .graph1607-label-main {
      position: absolute;
      left: 0;
      right: 0;
      text-align: center;
      font-weight: 600;
    }

    .graph1607-label-sup {
      position: absolute;
      right: 0;
      font-weight: 600;
    }

    .graph1607-bar-bg {
      position: relative;
      width: 100%;
      max-width: 500px;
      height: 20px;
      background: #ddd;
      border-radius: 10px;
      overflow: hidden;
      margin: 0 auto;
      display: flex;
    }

    .graph1607-bar-fill {
      height: 100%;
      background: #4caf50;
      width: 0%;
    }

    .graph1607-bar-sup {
      height: 100%;
      background: #f44336;
      width: 0%;
    }

    #resume {
      margin-top: 14px;
      font-size: 0.9rem;
      border-top: 1px solid #ddd;
      padding-top: 8px;
      line-height: 1.6;
    }

    /* Bandeau r√©sum√© rapide */
    #quickSummary {
      margin: 10px 0;
      padding: 8px 12px;
      border-radius: 6px;
      background: #e8f3ff;
      border: 1px solid #c5d8f5;
      font-weight: 600;
      font-size: 1.45rem; 
    }

    /* Couleurs d‚Äô√©pargne */
    .epargne-ok {
      background: #d8f5dd !important;
      border-color: #8bc68f !important;
    }

    .epargne-nok {
      background: #fbd5d5 !important;
      border-color: #e59a9a !important;
    }

    /* ===== MODALE ===== */
    #modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #modalBox {
      background: #ffffff;
      padding: 18px 22px;
      border-radius: 12px;
      max-width: 520px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
      font-size: 0.95rem;
    }

    #modalTitle {
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    #modalText {
      margin-bottom: 16px;
      line-height: 1.5;
    }

    #modalCloseBtn {
      display: inline-block;
      padding: 7px 16px;
      border-radius: 20px;
      border: none;
      background: #4caf50;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      float: right;
    }

    #modalCloseBtn:hover {
      background: #43a047;
    }
  </style>
</head>

<body>
  <h1>Gestion des jours √©pargnables (√©pargne temps / ‚Ç¨‚Ç¨‚Ç¨)</h1>

  <!-- Bandeau r√©sum√© rapide -->
  <div id="quickSummary">Synth√®se jours √©pargnables : en attente de calcul.</div>

  <!-- ====================== LIGNE 1 ====================== -->
  <div class="row">

    <!-- Donn√©es -->
    <div class="bloc bloc-agent">
      <h2>Donn√©es de l'agent</h2>

      <label>
        Heures effectu√©es dans l'ann√©e :
        <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
          <input type="number" id="heures" step="0.1" min="0" value="0">
          <select id="annee" onchange="majLibelleCR()"></select>
        </div>
      </label>

      <label>
        Nombre de CA restant (jours) :
        <input type="number" id="caRestant" step="1" min="0" value="0">
      </label>

      <label>
        Nombre de RTT restant (jours) :
        <input type="number" id="rttRestant" step="1" min="0" value="0">
      </label>

      <label>
        CRN-1 (jours) :
        <input type="number" id="crn1" step="0.01" min="0" value="0">
      </label>

      <div style="display:flex; gap:10px;">
        <button type="button" class="btn-primary" onclick="calculCET()">Calculer</button>
        <button type="button" class="btn-danger" onclick="resetAll()">Remise √† 0</button>
      </div>
    </div>

    <!-- R√©sultats principaux -->
    <div class="bloc resultat">
      <h2>R√©sultats</h2>

      <div class="graph1607-container">
        <div class="graph1607-label-row">
          <div class="graph1607-label-main" id="labelMain">
            0 / 1607 h
          </div>
          <div class="graph1607-label-sup" id="labelSup"></div>
        </div>

        <div class="graph1607-bar-bg" id="bg1607">
          <div class="graph1607-bar-fill" id="bar1607"></div>
          <div class="graph1607-bar-sup" id="barSup"></div>
        </div>
      </div>

      <label>
        Heures restantes pour atteindre 1607h :
        <input type="number" id="heuresRestantes" readonly>
      </label>

      <label>
        Heures suppl√©mentaires :
        <input type="number" id="heuresSupp" readonly>
      </label>

      <label>
        Jours th√©oriques issus des heures supp (heures supp / 7,8) :
        <input type="number" id="joursTheoriques" readonly>
      </label>

      <label>
        √âpargne totale possible (jours) :
        <input type="number" id="epargnePossible" readonly>
      </label>
    </div>
  </div>

  <!-- ====================== LIGNE 2 ====================== -->
  <div class="row">

    <div class="bloc resultat">
      <h3>√âpargne CA / RTT / CR</h3>

      <label>
        CA √©pargnables (9 jours maxi) :
        <input type="number" id="caEpargnables" readonly>
      </label>

      <label>
        RTT √©pargnables (21 jours maxi) :
        <input type="number" id="rttEpargnables" readonly>
      </label>

      <label>
        CRN-1 √©pargnables (15 jours maxi) :
        <input type="number" id="crn1Epargnables" readonly>
      </label>

      <label id="crLabel">
        CR utilisable en <span id="crAnnee"></span> :
        <input type="number" id="crJours" readonly>
      </label>

      <div id="resume"></div>
    </div>

    <div class="bloc resultat">
      <h3>CRN-1 / CRN-2</h3>

      <label>
        CRN-1 utilis√©s pour atteindre 1607h (jours) :
        <input type="number" id="crn1Utilises" readonly>
      </label>

      <label>
        CRN-2 (jours) :
        <input type="number" id="crn2" readonly>
      </label>
    </div>
  </div>

  <!-- ===== MODALE ===== -->
  <div id="modalOverlay">
    <div id="modalBox">
      <div id="modalTitle">R√©sum√© de votre situation CET</div>
      <div id="modalText"></div>
      <button id="modalCloseBtn" onclick="hideModal()">Fermer</button>
      <div style="clear:both;"></div>
    </div>
  </div>

  <!-- ====================== SCRIPT ====================== -->
  <script>
    function formatNum(n) {
      return Number.isInteger(n) ? n.toString() : n.toFixed(2);
    }

    function initAnnee() {
      const select = document.getElementById("annee");
      const current = new Date().getFullYear();

      for (let a = 2023; a <= 2032; a++) {
        const opt = document.createElement("option");
        opt.value = a;
        opt.textContent = a;
        if (a === current) opt.selected = true;
        select.appendChild(opt);
      }

      majLibelleCR();
    }

    function majLibelleCR() {
      const annee = parseInt(document.getElementById('annee').value, 10);
      document.getElementById('crAnnee').textContent = annee + 1;
    }

    function showModal(htmlContent) {
      document.getElementById('modalText').innerHTML = htmlContent;
      document.getElementById('modalOverlay').style.display = 'flex';
    }

    function hideModal() {
      document.getElementById('modalOverlay').style.display = 'none';
    }

    function resetEpargneColors() {
      ['caEpargnables', 'rttEpargnables', 'crn1Epargnables', 'crJours', 'crn2'].forEach(id => {
        document.getElementById(id).classList.remove('epargne-ok', 'epargne-nok');
      });
    }

    function resetAll() {
      document.getElementById('heures').value = 0;
      document.getElementById('caRestant').value = 0;
      document.getElementById('rttRestant').value = 0;
      document.getElementById('crn1').value = 0;

      const ids = [
        'heuresRestantes','heuresSupp','joursTheoriques','epargnePossible',
        'caEpargnables','rttEpargnables','crn1Epargnables','crJours',
        'crn1Utilises','crn2'
      ];
      ids.forEach(id => document.getElementById(id).value = 0);

      document.getElementById('bar1607').style.width = '0%';
      document.getElementById('barSup').style.width = '0%';
      document.getElementById('labelMain').textContent = '0 / 1607 h';
      document.getElementById('labelSup').textContent = '';

      document.getElementById('resume').innerHTML = '';
      document.getElementById('quickSummary').textContent = 'Synth√®se jours √©pargnables : en attente de calcul.';
      resetEpargneColors();
      hideModal();
    }

    function calculCET() {
      const heures = parseFloat(document.getElementById('heures').value) || 0;
      const caRestant = parseFloat(document.getElementById('caRestant').value) || 0;
      const rttRestant = parseFloat(document.getElementById('rttRestant').value) || 0;
      const crn1Input = parseFloat(document.getElementById('crn1').value) || 0;

      const HEURES_ANNUELLES = 1607;
      const HEURES_PAR_JOUR = 7.8;

      let caEpargnables = 0;
      let rttEpargnables = 0;
      let crJours = 0;
      let heuresSupp = 0;
      let joursTheoriques = 0;
      let heuresRestantes = 0;

      let crn1Utilises = 0;
      let crn1Epargnables = 0;
      let crn2 = 0;
      let crn1RestantsLogiques = 0;

      let seuil1607Atteint = false;
      let eligibleEpargneCA = false;
      let explicationCA = "";

      if (heures >= HEURES_ANNUELLES) {
        seuil1607Atteint = true;
        eligibleEpargneCA = true;
        heuresRestantes = 0;
        heuresSupp = heures - HEURES_ANNUELLES;
      } else {
        heuresRestantes = HEURES_ANNUELLES - heures;
      }

      if (!seuil1607Atteint && crn1Input > 0) {
        const heuresManquantes = HEURES_ANNUELLES - heures;
        const joursManquants = heuresManquantes / HEURES_PAR_JOUR;

        if (crn1Input >= joursManquants) {
          crn1Utilises = joursManquants;
          seuil1607Atteint = true;
          eligibleEpargneCA = true;
          heuresRestantes = 0;
        }
      }

      if (eligibleEpargneCA) {
        if (caRestant <= 9) {
          caEpargnables = caRestant;
        } else {
          caEpargnables = 0;
          explicationCA =
            "Vous avez bien atteint les 1607 h, mais vous ne pouvez pas √©pargner de CA car il vous reste plus de 9 jours, ce qui signifie que vous n‚Äôavez pas pos√© les 20 jours minimum de CA requis.";
        }
      }

      if (heuresSupp > 0) {
  // Calcul des jours th√©oriques issus des heures supp
  joursTheoriques = heuresSupp / HEURES_PAR_JOUR;

  // Corrige les erreurs d'arrondi type 20.999999999 en ajoutant un epsilon
  const maxRTT = Math.floor(joursTheoriques + 1e-9);

  rttEpargnables = Math.min(rttRestant, maxRTT);

  // M√™me correction pour le calcul du CR
  crJours = Math.floor((joursTheoriques - rttEpargnables) + 1e-9);
}


      if (seuil1607Atteint) {
        crn1RestantsLogiques = Math.max(0, crn1Input - crn1Utilises);
        crn1Epargnables = Math.min(crn1RestantsLogiques, 15);
        crn2 = Math.max(0, crn1RestantsLogiques - crn1Epargnables);
      }

      const epargnePossible =
        caEpargnables + rttEpargnables + crn1Epargnables;

      document.getElementById("epargnePossible").value = formatNum(epargnePossible);
      document.getElementById("caEpargnables").value = formatNum(caEpargnables);
      document.getElementById("rttEpargnables").value = formatNum(rttEpargnables);
      document.getElementById("crn1Epargnables").value = formatNum(crn1Epargnables);
      document.getElementById("crJours").value = formatNum(crJours);
      document.getElementById("heuresSupp").value = formatNum(heuresSupp);
      document.getElementById("joursTheoriques").value = formatNum(joursTheoriques);
      document.getElementById("heuresRestantes").value = formatNum(heuresRestantes);
      document.getElementById("crn1Utilises").value = formatNum(crn1Utilises);
      document.getElementById("crn2").value = formatNum(crn2);

      const bar = document.getElementById("bar1607");
      const barSup = document.getElementById("barSup");
      const labMain = document.getElementById("labelMain");
      const labSup = document.getElementById("labelSup");

      let heuresEquivalentes =
        seuil1607Atteint ? HEURES_ANNUELLES : Math.min(heures, HEURES_ANNUELLES);

      labMain.textContent = `${formatNum(heuresEquivalentes)} / 1607 h`;

      if (heuresSupp > 0) {
        const total = HEURES_ANNUELLES + heuresSupp;
        const greenPct = (HEURES_ANNUELLES / total) * 100;
        const redPct = (heuresSupp / total) * 100;

        bar.style.width = greenPct + "%";
        barSup.style.width = redPct + "%";

        bar.style.borderRadius = "10px 0 0 10px";
        barSup.style.borderRadius = "0 10px 10px 0";

        labSup.textContent = `+${formatNum(heuresSupp)} h sup`;
      } else {
        labSup.textContent = "";
        if (seuil1607Atteint) {
          bar.style.width = "100%";
        } else {
          bar.style.width = (heures / HEURES_ANNUELLES) * 100 + "%";
        }
        barSup.style.width = "0%";
      }

      let resume = "";

      if (seuil1607Atteint) {
        if (heures >= 1607) {
          const supp = heures - 1607;
          resume += `Vous atteignez le seuil de 1607 h uniquement avec vos heures effectu√©es.<br><br>`;
          resume += `Vous avez effectu√© ${formatNum(heures)}h, soit ${formatNum(supp)}h suppl√©mentaires.<br><br>`;
        } else {
          resume += `Vous atteignez le seuil de 1607 h gr√¢ce √† ${formatNum(crn1Utilises)} jour(s) de CRN-1 utilis√©s.<br><br>`;
        }

        resume += `Vous pouvez √©pargner ${formatNum(caEpargnables)} jour(s) de CA et ${formatNum(rttEpargnables)} jour(s) de RTT.<br><br>`;

        if (explicationCA !== "") {
          resume += `<span style="color:#c62828;">${explicationCA}</span><br><br>`;
        }

        resume += `Il vous reste ${formatNum(crn1RestantsLogiques)} jour(s) de CRN-1 apr√®s utilisation, dont ${formatNum(crn1Epargnables)} jour(s) √©pargnable(s).<br><br>`;
        resume += `Le surplus √©ventuel de CRN-1 alimente ${formatNum(crn2)} jour(s) de CRN-2.`;
      } else {
        resume += `Vous n'atteignez pas le seuil de 1607 h : il manque encore ${formatNum(heuresRestantes)} heure(s).<br><br>`;
        if (crn1Input > 0) {
          resume += `Vos ${formatNum(crn1Input)} CRN-1 ne suffisent pas √† atteindre 1607 h et ne sont donc pas √©pargnables cette ann√©e.`;
        } else {
          resume += `Vous ne disposez d'aucun CRN-1 pour combler ce manque.`;
        }
      }

      document.getElementById('resume').innerHTML = resume;

      /* üîµ Mise √† jour du bandeau synth√®se */
      document.getElementById('quickSummary').textContent =
        `Synth√®se jours √©pargnables : ${formatNum(caEpargnables)} CA / ${formatNum(rttEpargnables)} RTT / ${formatNum(crn1Epargnables)} CRN-1 / ${formatNum(crJours)} CR / ${formatNum(crn2)} CRN-2`;

      /* Couleurs (vert si > 0, rouge sinon) */
      resetEpargneColors();

      const caField   = document.getElementById('caEpargnables');
      const rttField  = document.getElementById('rttEpargnables');
      const crn1Field = document.getElementById('crn1Epargnables');
      const crField   = document.getElementById('crJours');
      const crn2Field = document.getElementById('crn2');

      (caEpargnables > 0 ? caField.classList.add('epargne-ok') : caField.classList.add('epargne-nok'));
      (rttEpargnables > 0 ? rttField.classList.add('epargne-ok') : rttField.classList.add('epargne-nok'));
      (crn1Epargnables > 0 ? crn1Field.classList.add('epargne-ok') : crn1Field.classList.add('epargne-nok'));
      (crJours > 0 ? crField.classList.add('epargne-ok') : crField.classList.add('epargne-nok'));

      if (crn2 > 0) crn2Field.classList.add('epargne-ok');

      showModal(resume);
    }

    initAnnee();
  </script>

</body>
</html>
